{% extends 'index.html' %}
{% block title %}
My Parking History
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card bg-dark text-white">
                <div class="card-header">
                    <h2>üìä My Parking History</h2>
                    <p class="mb-0">Complete record of all your parking sessions</p>
                </div>
                <div class="card-body">
                    <!-- History Statistics -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h5>Total Sessions</h5>
                                    <h3>{{ reservations_with_details|length }}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h5>Completed Sessions</h5>
                                    <h3>{{ reservations_with_details|selectattr('reservation.release_time')|list|length }}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h5>Total Spent</h5>
                                    <h3>‚Çπ{{ reservations_with_details|sum(attribute='reservation.parkingcost') }}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h5>Total Hours</h5>
                                    <h3>{{ reservations_with_details|selectattr('duration_hours')|sum(attribute='duration_hours')|round(1) }}</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Complete Parking History -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4>üìã All Parking Sessions</h4>
                            {% if reservations_with_details %}
                                <div class="table-responsive">
                                    <table class="table table-dark table-striped">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Spot ID</th>
                                                <th>Parking Lot</th>
                                                <th>Vehicle Number</th>
                                                <th>Parking Time</th>
                                                <th>Release Time</th>
                                                <th>Duration</th>
                                                <th>Cost</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in reservations_with_details %}
                                            <tr>
                                                <td>{{ item.reservation.parking_time.strftime('%Y-%m-%d') }}</td>
                                                <td>{{ item.spot.id }}</td>
                                                <td>{{ item.lot.location }}</td>
                                                <td>{{ item.reservation.veichleNumber or 'N/A' }}</td>
                                                <td>{{ item.reservation.parking_time.strftime('%H:%M') }}</td>
                                                <td>
                                                    {% if item.reservation.release_time %}
                                                        {{ item.reservation.release_time.strftime('%H:%M') }}
                                                    {% else %}
                                                        <span class="text-warning">Active</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if item.duration_hours %}
                                                        <span class="badge badge-success">
                                                            {{ item.duration_hours }} hours
                                                        </span>
                                                    {% else %}
                                                        <span class="badge badge-warning">Active</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if item.reservation.parkingcost > 0 %}
                                                        ‚Çπ{{ item.reservation.parkingcost }}
                                                    {% else %}
                                                        <span class="text-warning">Pending</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if item.reservation.release_time %}
                                                        <span class="badge badge-success">Completed</span>
                                                    {% else %}
                                                        <span class="badge badge-warning">Active</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <h5>No Parking History</h5>
                                    <p>You haven't made any parking reservations yet.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Summary by Parking Lot -->
                    {% if reservations_with_details %}
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4>üìà Summary by Parking Lot</h4>
                            <div class="row">
                                {% set lot_summary = {} %}
                                {% for item in reservations_with_details %}
                                    {% set lot_name = item.lot.location %}
                                    {% if lot_name not in lot_summary %}
                                        {% set _ = lot_summary.update({lot_name: {'sessions': 0, 'total_cost': 0, 'total_hours': 0}}) %}
                                    {% endif %}
                                    {% set _ = lot_summary[lot_name].update({'sessions': lot_summary[lot_name]['sessions'] + 1}) %}
                                    {% if item.reservation.parkingcost %}
                                        {% set _ = lot_summary[lot_name].update({'total_cost': lot_summary[lot_name]['total_cost'] + item.reservation.parkingcost}) %}
                                    {% endif %}
                                    {% if item.duration_hours %}
                                        {% set _ = lot_summary[lot_name].update({'total_hours': lot_summary[lot_name]['total_hours'] + item.duration_hours}) %}
                                    {% endif %}
                                {% endfor %}
                                
                                {% for lot_name, stats in lot_summary.items() %}
                                <div class="col-md-4 mb-3">
                                    <div class="card bg-secondary text-white">
                                        <div class="card-header">
                                            <h6>{{ lot_name }}</h6>
                                        </div>
                                        <div class="card-body">
                                            <p><strong>Sessions:</strong> {{ stats.sessions }}</p>
                                            <p><strong>Total Cost:</strong> ‚Çπ{{ stats.total_cost }}</p>
                                            <p><strong>Total Hours:</strong> {{ stats.total_hours|round(1) }}</p>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <div class="mt-4">
                        <a href="{{ url_for('controllers.user_dashboard') }}" class="btn btn-secondary">
                            ‚Üê Back to Dashboard
                        </a>
                        <a href="{{ url_for('controllers.parking_lots') }}" class="btn btn-success">
                            Book New Spot
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} 